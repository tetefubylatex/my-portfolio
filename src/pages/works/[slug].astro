---
import { getCollection } from 'astro:content';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import '../../styles/global.css';

export async function getStaticPaths() {
  const works = await getCollection('works');
  
  // 日付順に並べてインデックスを作成
  const sortedWorks = works.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
  
  return sortedWorks.map((entry, index) => {
    // 関連作品を取得（同じタグを持つ、自身以外の作品4件）
    const relatedWorks = sortedWorks
      .filter(w => w.data.slug !== entry.data.slug && w.data.tags.some(tag => entry.data.tags.includes(tag)))
      .slice(0, 4)
      .map(w => ({
        slug: w.data.slug,
        title: w.data.title,
        image: w.data.image
      }));
    
    // prev/next のslug
    const prevSlug = index > 0 ? sortedWorks[index - 1].data.slug : null;
    const nextSlug = index < sortedWorks.length - 1 ? sortedWorks[index + 1].data.slug : null;
    
    return {
      params: { slug: entry.data.slug },
      props: { 
        title: entry.data.title,
        author: entry.data.author,
        charName: entry.data.charName,
        date: entry.data.date,
        image: entry.data.image,
        software: entry.data.software,
        tags: entry.data.tags,
        body: entry.body,
        relatedWorks: relatedWorks,
        prevSlug: prevSlug,
        nextSlug: nextSlug
      }
    };
  });
}

interface Props {
  title: string;
  author?: string;
  charName?: string;
  date: Date;
  image: string;
  software?: string;
  tags: string[];
  body: string;
  relatedWorks: Array<{slug: string; title: string; image: string}>;
  prevSlug: string | null;
  nextSlug: string | null;
}

const { title, author, charName, date, image, software, tags, body, relatedWorks, prevSlug, nextSlug } = Astro.props;
const imageUrl = `/images/works/${image}`;
---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
</head>
<body>
    <Header />

    <main class="work-page-container">
        <div class="split-layout">
            
            <aside class="artwork-column">
                <nav class="top-nav">
                    <a href="/gallery" class="back-link">← Back to Gallery</a>
                </nav>
                <div class="sticky-image-container">
                    <img src={imageUrl} alt={title} class="main-artwork" />
                </div>
            </aside>

            <section class="info-column">
                <h1 class="work-title">{title}</h1>
                
                <div class="detail-block">
                    <h3>Memo</h3>
                    <p class="memo-text" set:html={body}></p>
                </div>

                <div class="detail-block">
                    <h3>Character</h3>
                    <p>{charName || "---"}</p>
                </div>

                <div class="detail-block">
                    <h3>Tags</h3>
                    <div class="tags">
                        {tags.map((tag: string) => (
                            <a href={`/gallery?tag=${tag}`} class="tag-link">
                                <span class="tag">#{tag}</span>
                            </a>
                        ))}
                    </div>
                </div>

                <div class="detail-block">
                    <h3>Release Date</h3>
                    <p>{date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.')}</p>
                </div>
                <div class="detail-block">
                    <h3>Artist</h3>
                    <p>{author || "テテフでLaTeX"}</p>
                </div>

                <div class="detail-block">
                    <h3>Software</h3>
                    <p>{software || "---"}</p>
                </div>

                {relatedWorks.length > 0 && (
                    <div class="related-mini-section">
                        <h3>Related Works</h3>
                        <div class="related-mini-grid">
                            {relatedWorks.map((related) => (
                                <a href={`/works/${related.slug}`} class="related-mini-item">
                                    <img src={`/images/works/${related.image}`} alt={related.title} />
                                </a>
                            ))}
                        </div>
                    </div>
                )}

                <div class="pagination">
                    {prevSlug ? <a href={`/works/${prevSlug}`} class="page-btn">← prev</a> : <span class="disabled">← prev</span>}
                    {nextSlug ? <a href={`/works/${nextSlug}`} class="page-btn">next →</a> : <span class="disabled">next →</span>}
                </div>
            </section>
        </div>
    </main>

    <Footer />
</body>
</html>

<style is:global>
    html, body {
        overflow-x: hidden !important;
        height: auto !important;
    }
    main, #__astro, .container {
        display: block !important;
    }
    /* 作品ページに限り、stickyを邪魔するhiddenをすべて無効化する */
    html, body, main, .work-page-container, .split-layout {
        overflow: visible !important;
    }
</style>

<style>
    
    .work-page-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .split-layout {
        display: flex;
        gap: 60px;
        align-items: flex-start;
    }

    /* 左側：固定設定 */

    .top-nav {
        margin-bottom: 20px;
    }

    .sticky-image-container {
        width: 100%;
        display: flex;
        justify-content: center;
    }
    /* 左側：カラム全体 */
    .artwork-column {
        flex: 1;
        position: sticky;
        top: 40px; /* 画面上部からの固定位置 */
        z-index: 10;
        
        /* 【重要】高さを固定せず、中身（画像）の高さに合わせる */
        height: fit-content; 
        /* 【重要】これを入れることで、stickyが正しく機能します */
        align-self: flex-start; 
    }

    .sticky-image-container {
        width: 100%;
        display: flex;
        justify-content: center;
        /* ここに余計な height 指定がないことを確認してください */
    }

    .main-artwork {
        display: block;
        /* 最初は画面に収まるように制限をかけておく */
        max-width: 100%;
        max-height: calc(100vh - 120px);
        object-fit: contain;
        border-radius: 2px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }



    /* 右側：情報カラム */
    .info-column {
        width: 300px;
        flex-shrink: 0;
        padding-top: 50px;
    }

    .back-link {
        text-decoration: none;
        color: #888 !important;
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        transition: color 0.2s;
    }

    .back-link:hover { color: #111 !important; }

    .tag-link {
        text-decoration: none;
        display: inline-block;
        margin-right: 8px;
        transition: transform 0.1s;
    }

    .tag-link:hover { transform: translateY(-1px); }

    .tag {
        font-size: 0.8rem;
        color: #888;
        font-weight: 600;
    }

    .tag-link:hover .tag { color: #111; }  

    .work-title {
        font-size: 1.6rem;
        margin-bottom: 40px;
        font-weight: 700;
        color: #111;
        line-height: 1.2;
    }
    

    .detail-block { margin-bottom: 30px; }
    .detail-block h3, .related-mini-section h3 {
        font-size: 0.7rem;
        color: #ccc;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        margin-bottom: 10px;
    }
    .detail-block p { font-size: 0.95rem; color: #444; margin: 0; }
    .memo-text { white-space: pre-wrap; line-height: 1.8; }

    /* 関連作品 */
    .related-mini-section {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 1px solid #eee;
    }
    .related-mini-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }
    .related-mini-item img {
        width: 100%;
        aspect-ratio: 1/1;
        object-position: center 20%; 
        object-fit: cover;
        border-radius: 3px;
        transition: 0.3s;
    }
    .related-mini-item:hover img {
        opacity: 0.7;
        transform: scale(1.05);
    }

    /* ページネーション */
    .pagination {
        display: flex;
        justify-content: space-between;
        margin-top: 50px;
        font-size: 0.85rem;
        border-top: 1px solid #eee;
        padding-top: 25px;
    }
    .page-btn { text-decoration: none; color: #111; font-weight: bold; }
    .disabled { color: #eee; }

    @media (max-width: 900px) {
        .split-layout { flex-direction: column; gap: 40px; }
        .artwork-column { position: static; width: 100%; height: auto; }
        .info-column { width: 100%; padding-top: 0; }
        .main-artwork { max-height: none; }
    }
</style>
<script>
    function fixImageSize() {
        const img = document.querySelector('.main-artwork') as HTMLImageElement;
        if (!img) return;

        const applyFix = () => {
            // 現在の「画面に美しく収まっているサイズ」を計測
            const rect = img.getBoundingClientRect();
            
            // 画像のサイズだけをpxで物理固定（これで呼吸/リサイズを防ぐ）
            img.style.width = `${rect.width}px`;
            img.style.height = `${rect.height}px`;
            
            // 追従を邪魔しないよう、max-heightの制約を維持する
            img.style.maxWidth = '100%';
            img.style.maxHeight = 'calc(100vh - 120px)';
        };

        if (img.complete) {
            applyFix();
        } else {
            img.onload = applyFix;
        }
    }

    // 読み込み時とAstroの遷移時に実行
    window.addEventListener('load', fixImageSize);
    document.addEventListener('astro:page-load', fixImageSize);
</script>
