---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import '../../styles/global.css'; 

export async function getStaticPaths() {
  const images = await Astro.glob('../../assets/works/**/*.{jpg,jpeg,png,webp,JPG,JPEG,PNG,WEBP}');
  const infoFiles = await Astro.glob('../../assets/works/**/*.json');

  const allWorks = images.map((img) => {
    const imagePath = img.file || img.default.src;
    const filename = imagePath.split('/').pop().split('?')[0];
    const slug = filename.split('.')[0];
    const infoFile = infoFiles.find((f) => (f.default?.id === slug));
    const content = infoFile?.default || {};
    
    return {
      slug,
      src: img.default.src,
      title: content.title || slug,
      charName: content.charName || "---",
      date: content.date || "2026.01.26",
      memo: content.memo || "説明文がありません。",
      software: content.software || "---",
      tags: content.tags || []
    };
  });

  return allWorks.map((work, index) => {
    const relatedWorks = allWorks
      .filter(w => w.slug !== work.slug && w.tags.some(tag => work.tags.includes(tag)))
      .slice(0, 4);

    return {
      params: { slug: work.slug },
      props: { info: work, prevSlug: index > 0 ? allWorks[index - 1].slug : null, nextSlug: index < allWorks.length - 1 ? allWorks[index + 1].slug : null, relatedWorks }
    };
  });
}

const { info, prevSlug, nextSlug, relatedWorks } = Astro.props;
---

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{info.title}</title>
</head>
<body>
    <Header />

    <main class="work-page-container">
        <div class="split-layout">
            
            <aside class="artwork-column">
                <nav class="top-nav">
                    <a href="/gallery" class="back-link">← Back to Gallery</a>
                </nav>
                <div class="sticky-image-container">
                    <img src={info.src} alt={info.title} class="main-artwork" />
                </div>
            </aside>

            <section class="info-column">
                <h1 class="work-title">{info.title}</h1>
                
                <div class="detail-block">
                    <h3>Memo</h3>
                    <p class="memo-text">{info.memo}</p>
                </div>

                <div class="detail-block">
                    <h3>Character</h3>
                    <p>{info.charName}</p>
                </div>

                <div class="detail-block">
                    <h3>Tags</h3>
                    <div class="tags">
                        {info.tags.map(tag => (
                            <a href={`/gallery?tag=${tag}`} class="tag-link">
                                <span class="tag">#{tag}</span>
                            </a>
                        ))}
                    </div>
                </div>

                <div class="detail-block">
                    <h3>Release Date</h3>
                    <p>{info.date}</p>
                </div>

                <div class="detail-block">
                    <h3>Software</h3>
                    <p>{info.software}</p>
                </div>

                {relatedWorks.length > 0 && (
                    <div class="related-mini-section">
                        <h3>Related Works</h3>
                        <div class="related-mini-grid">
                            {relatedWorks.map(related => (
                                <a href={`/works/${related.slug}`} class="related-mini-item">
                                    <img src={related.src} alt={related.title} />
                                </a>
                            ))}
                        </div>
                    </div>
                )}

                <div class="pagination">
                    {prevSlug ? <a href={`/works/${prevSlug}`} class="page-btn">← prev</a> : <span class="disabled">← prev</span>}
                    {nextSlug ? <a href={`/works/${nextSlug}`} class="page-btn">next →</a> : <span class="disabled">next →</span>}
                </div>
            </section>
        </div>
    </main>

    <Footer />
</body>
</html>

<style is:global>
    html, body {
        overflow-x: hidden !important;
        height: auto !important;
    }
    main, #__astro, .container {
        display: block !important;
    }
</style>

<style>
    .work-page-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .split-layout {
        display: flex;
        gap: 60px;
        align-items: flex-start;
    }

    /* 左側：固定設定 */

    .top-nav {
        margin-bottom: 20px;
    }

    .sticky-image-container {
        width: 100%;
        display: flex;
        justify-content: center;
    }

       .artwork-column {
        flex: 1;
        position: sticky;
        top: 40px; 
        z-index: 10;
        /* 高さを明示的に持たせない（画像に任せる） */
        height: min-content; 
        align-self: flex-start;
    }

    .main-artwork {
        display: block;
        /* 初期の制限だけかけておき、あとはJSで固定します */
        max-width: 100%;
        max-height: calc(100vh - 120px);
        object-fit: contain;
        border-radius: 2px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }


    /* 右側：情報カラム */
    .info-column {
        width: 300px;
        flex-shrink: 0;
        padding-top: 50px;
    }

    .back-link {
        text-decoration: none;
        color: #888 !important;
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        transition: color 0.2s;
    }

    .back-link:hover { color: #111 !important; }

    .tag-link {
        text-decoration: none;
        display: inline-block;
        margin-right: 8px;
        transition: transform 0.1s;
    }

    .tag-link:hover { transform: translateY(-1px); }

    .tag {
        font-size: 0.8rem;
        color: #888;
        font-weight: 600;
    }

    .tag-link:hover .tag { color: #111; }  

    .work-title {
        font-size: 1.6rem;
        margin-bottom: 40px;
        font-weight: 700;
        color: #111;
        line-height: 1.2;
    }

    .detail-block { margin-bottom: 30px; }
    .detail-block h3, .related-mini-section h3 {
        font-size: 0.7rem;
        color: #ccc;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        margin-bottom: 10px;
    }
    .detail-block p { font-size: 0.95rem; color: #444; margin: 0; }
    .memo-text { white-space: pre-wrap; line-height: 1.8; }

    /* 関連作品 */
    .related-mini-section {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 1px solid #eee;
    }
    .related-mini-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }
    .related-mini-item img {
        width: 100%;
        aspect-ratio: 1/1;
        object-fit: cover;
        border-radius: 3px;
        transition: 0.3s;
    }
    .related-mini-item:hover img {
        opacity: 0.7;
        transform: scale(1.05);
    }

    /* ページネーション */
    .pagination {
        display: flex;
        justify-content: space-between;
        margin-top: 50px;
        font-size: 0.85rem;
        border-top: 1px solid #eee;
        padding-top: 25px;
    }
    .page-btn { text-decoration: none; color: #111; font-weight: bold; }
    .disabled { color: #eee; }

    @media (max-width: 900px) {
        .split-layout { flex-direction: column; gap: 40px; }
        .artwork-column { position: static; width: 100%; height: auto; }
        .info-column { width: 100%; padding-top: 0; }
        .main-artwork { max-height: none; }
    }
</style>
<script>
    function fixImageSize() {
        const img = document.querySelector('.main-artwork') as HTMLImageElement;
        if (!img) return;

        // 画像が読み込まれるのを待ってからサイズを固定
        const applyFix = () => {
            const rect = img.getBoundingClientRect();
            // 取得した現在のサイズを、style属性として直接書き込む
            img.style.width = `${rect.width}px`;
            img.style.height = `${rect.height}px`;
            img.style.maxWidth = 'none';
            img.style.maxHeight = 'none';
        };

        if (img.complete) {
            applyFix();
        } else {
            img.onload = applyFix;
        }
    }

    // ページ読み込み時と、Astroの遷移時に実行
    window.addEventListener('load', fixImageSize);
    document.addEventListener('astro:page-load', fixImageSize);
</script>
