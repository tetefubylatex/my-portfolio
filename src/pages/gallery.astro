---
import Layout from '../layouts/BlogPost.astro';

let images = [];
let infoFiles = [];
try {
  images = await Astro.glob('../assets/works/**/*.{jpg,jpeg,png,webp,JPG,JPEG,PNG,WEBP}');
  infoFiles = await Astro.glob('../assets/works/**/*.json');
} catch (e) {
  console.log("読み込みエラー");
}

// 画像とJSONを紐付けたデータリストを作成
const allWorks = images.map(img => {
  const imagePath = img.file || img.default.src;
  const filename = imagePath.split('/').pop().split('?')[0];
  const slug = filename.split('.')[0];
  const info = infoFiles.find(f => (f.default?.id === slug));
  
  return {
    slug,
    src: img.default.src,
    tags: info?.default?.tags || []
  };
});

// 全タグ抽出
const allTags = [...new Set(allWorks.flatMap(work => work.tags))];

// URLから ?tag= の値を取得する
const { searchParams } = Astro.url;
const initialTag = searchParams.get('tag');

const props = { title: 'Gallery', description: '作品集', pubDate: new Date() };
---

<Layout {...props}>
    <style is:global>
        main, .container, article, .content, .prose {
            max-width: 1080px !important; 
            margin: 0 auto !important; 
            width: 100% !important; 
        }
        /* Blogレイアウト特有のタイトル等の余白を消す */
        .title, .date, hr { display: none !important; }
    </style>

    <div class="gallery-page-container" id="gallery-root" data-initial-tag={initialTag}>
        <div class="filter-container">
            <button class="filter-btn active" data-tag="all">All</button>
            {allTags.map(tag => (
                <button class="filter-btn" data-tag={tag}>#{tag}</button>
            ))}
        </div>

        <div class="full-gallery">
            {allWorks.map((work) => (
                <div class="work-item" data-tags={JSON.stringify(work.tags)}>
                    <a href={`/works/${work.slug}`} class="hover-popup">
                        <img src={work.src} alt="作品" loading="lazy" />
                    </a>
                </div>
            ))}
        </div>
    </div>

        <script>
        // フィルタリング処理のメイン関数
        function initGallery() {
            const buttons = document.querySelectorAll('.filter-btn');
            const items = document.querySelectorAll('.work-item');
            const root = document.getElementById('gallery-root');
            
            // URLから直接パラメータを取得する
            const params = new URLSearchParams(window.location.search);
            const initialTag = params.get('tag');

            function filterByTag(targetTag) {
                if (!targetTag) return;

                buttons.forEach(b => {
                    if (b.getAttribute('data-tag') === targetTag) {
                        b.classList.add('active');
                    } else {
                        b.classList.remove('active');
                    }
                });

                items.forEach(item => {
                    const attr = item.getAttribute('data-tags');
                    const itemTags = JSON.parse(attr || '[]');
                    if (targetTag === 'all' || itemTags.includes(targetTag)) {
                        (item as HTMLElement).style.display = 'block';
                    } else {
                        (item as HTMLElement).style.display = 'none';
                    }
                });
            }

            // ボタンクリックイベント
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tag = btn.getAttribute('data-tag');
                    // URLを書き換えない（戻るボタン対策）場合は単純にフィルタリング
                    filterByTag(tag);
                });
            });

            // 初期実行
            if (initialTag) {
                filterByTag(initialTag);
            }
        }

        // 通常の読み込み時
        window.addEventListener('DOMContentLoaded', initGallery);

        // AstroのView Transitions（もし使っていれば）対策
        document.addEventListener('astro:page-load', initGallery);
        
        // 念のため即時実行も試みる
        initGallery();
    </script>
</Layout>

<style>
    .filter-container { margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-btn {
        padding: 5px 15px; border: 1px solid #ddd; background: white; border-radius: 20px;
        cursor: pointer; transition: 0.3s; font-size: 0.9rem;
    }
    .filter-btn.active { background: #333; color: white; border-color: #333; }
    
    .full-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        padding: 0;
        width: 100%;
    }

    .full-gallery img {
        width: 100%;
        /* aspect-ratio: 1 / 1;  正方形にする場合。不要なら削除してください */
        object-fit: cover;
        object-position: center 20%;
        display: block;
        transition: transform 0.3s ease, filter 0.3s ease;
    }

    @media (max-width: 720px) {
        .full-gallery { grid-template-columns: repeat(2, 1fr); }
    }

    .hover-popup:hover img {
        transform: scale(1.1);
        filter: brightness(0.7);
        z-index: 10;
        position: relative;
    }
    .hover-popup {
        overflow: hidden; /* 拡大した時に枠からはみ出さないように */
        display: block;
    }
</style>
