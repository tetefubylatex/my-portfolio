---
import Layout from '../layouts/BlogPost.astro';
import { getCollection } from 'astro:content';

// Content Collectionsから works を取得
const allWorksCollections = await getCollection('works');

// 作品データを整形＆日付順にソート（新しい順）
const allWorks = allWorksCollections
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .map(work => ({
    slug: work.data.slug,
    src: `/images/works/${work.data.image}`,
    tags: work.data.tags || []
  }));

// 全タグ抽出
const allTags = [...new Set(allWorks.flatMap(work => work.tags))];

// URLから ?tag= の値を取得する
const { searchParams } = Astro.url;
const initialTag = searchParams.get('tag');

const props = { title: 'Gallery', description: '作品集', pubDate: new Date() };
---

<Layout {...props}>
    <style is:global>
        main {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .prose {
            max-width: 1080px !important;
            margin: 0 auto !important;
            width: 100% !important;
            padding: 0 !important;
        }
        /* Blogレイアウト特有のタイトル等の余白を消す */
        .title, .date, hr { display: none !important; }
    </style>

    <div class="gallery-page-container" id="gallery-root" data-initial-tag={initialTag}>
        <div class="filter-container">
            <button class="filter-btn active" data-tag="all">All</button>
            {allTags.map(tag => (
                <button class="filter-btn" data-tag={tag}>#{tag}</button>
            ))}
        </div>

        <div class="full-gallery">
            {allWorks.map((work) => (
                <div class="work-item" data-tags={JSON.stringify(work.tags)}>
                    <a href={`/works/${work.slug}`} class="hover-popup">
                        <img src={work.src} alt="作品" loading="lazy" />
                    </a>
                </div>
            ))}
        </div>
    </div>

<script>
    function initGallery() {
        const buttons = document.querySelectorAll('.filter-btn');
        const items = document.querySelectorAll('.work-item');
        
        // --- 1. 画面内に入った時の処理 ---
        const observerOptions = {
            rootMargin: '0px 0px -50px 0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries) => {
            // 画面内に入った要素だけを抽出
            const visibleEntries = entries.filter(entry => entry.isIntersecting);
            
            visibleEntries.forEach((entry, index) => {
                const target = entry.target as HTMLElement;
                // 画面内の順番に応じてディレイを計算 (100msずつずらす)
                setTimeout(() => {
                    target.classList.add('is-visible');
                }, index * 100); 
                
                observer.unobserve(target);
            });
        }, observerOptions);

        // --- 2. フィルタリング処理 ---
        function filterByTag(targetTag) {
            if (!targetTag) return;

            buttons.forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-tag') === targetTag);
            });

            // 表示するアイテムのカウント用
            let visibleCount = 0;

            items.forEach((item) => {
                const hItem = item as HTMLElement;
                const itemTags = JSON.parse(hItem.getAttribute('data-tags') || '[]');
                
                if (targetTag === 'all' || itemTags.includes(targetTag)) {
                    hItem.style.display = 'block';
                    hItem.classList.remove('is-visible'); // 一旦リセット
                    
                    // 表示されるものだけ順番にディレイをかけて再表示
                    setTimeout(() => {
                        hItem.classList.add('is-visible');
                    }, visibleCount * 100); // 0.1秒ずつずらす
                    
                    visibleCount++;
                } else {
                    hItem.style.display = 'none';
                    hItem.classList.remove('is-visible');
                }
            });
        }

        // 監視開始
        items.forEach(item => observer.observe(item));

        // ボタンイベント
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const tag = btn.getAttribute('data-tag');
                filterByTag(tag);
            });
        });

        // 初期実行
        const params = new URLSearchParams(window.location.search);
        const initialTag = params.get('tag');
        if (initialTag) {
            filterByTag(initialTag);
        }
    }

    document.addEventListener('astro:page-load', initGallery);
    initGallery();
</script>



</Layout>

<style>
        /* ギャラリーページコンテナのセンター配置 */
    .gallery-page-container {
        max-width: 1080px;
        margin: 0 auto !important;
        padding: 2em 20px;
        box-sizing: border-box;
        width: 100%;
    }

    /* 初期状態：透明で少し下に下げておく */
    .work-item {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }

    /* 画面に入った時に付与するクラス */
    .work-item.is-visible {
        opacity: 1;
        transform: translateY(0);
    }

    .filter-container { margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-btn {
        padding: 5px 15px; border: 1px solid #ddd; background: white; border-radius: 20px;
        cursor: pointer; transition: 0.3s; font-size: 0.9rem;
    }
    .filter-btn.active { background: #333; color: white; border-color: #333; }
    
        .full-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        width: 100%;
        /* 拡大した画像がページ全体からはみ出さないように設定 */
        overflow: visible; 
    }

    /* 各作品のコンテナ */
    .work-item {
        position: relative;
        /* ここで overflow: hidden を使うと枠を超えられないので visible にします */
        overflow: visible; 
    }

    .hover-popup {
        display: block;
        width: 100%;
        text-decoration: none;
    }

    .full-gallery img {
        width: 100%;
        object-fit: cover;
        object-position: center 20%;
        display: block;
        border-radius: 2px;
        /* アニメーションの設定 */
        transition: transform 0.3s ease, filter 0.3s ease, box-shadow 0.3s ease;
    }

    /* 【重要】カーソルを合わせた時の演出 */
    .hover-popup:hover img {
        transform: scale(1.1); /* 1.1倍に拡大 */
        filter: brightness(0.8); /* 少し暗くする */
        z-index: 50; /* 他の画像より上に表示 */
        position: relative; /* z-indexを有効にするため */
        box-shadow: 0 10px 30px rgba(0,0,0,0.3); /* 浮かび上がって見える影 */
    }

    /* 前後の重なり順を制御 */
    .work-item:hover {
        z-index: 100;
    }

    /* スマホ対応：2列 */
    @media (max-width: 720px) {
        .gallery-page-container {
            padding: 2em 12px !important;
            margin: 0 auto !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .full-gallery {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
    }
        }
    }
</style>
